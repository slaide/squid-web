<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Native Page</title>
        <style>
            *{
                margin:0;
                border:0;
                padding:0;
                font-family:Arial;
            }
            body{
                --inactive-color:white;
                --idle-color:rgb(236, 236, 236);
                --active-color:lightblue;
            }
            input,select{
                width:auto;
                height:1.5em;
                border-bottom:1px solid grey;
            }
            label,button,select{
                user-select: none;
            }
            select,button,input{
                cursor:pointer;
            }
            input[type=text],input[type=number]{
                cursor:text;
            }
            button{
                background-color:var(--idle-color);
                border:1px solid black;
                border-radius:0.5em;
                padding:0.2em;
                padding-left:0.5em;
                padding-right:0.5em;
            }
            button:hover{
                background-color:rgb(175, 175, 175);
            }
            img{
                image-rendering: pixelated;
            }
            li{
                margin-left:1.5em;
            }
            code{
                font-family: monospace;
            }
            .has-tooltip:not(button){
                cursor:help;
            }
        </style>
        <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
        <script src="components/p/init.js"></script>
    </head>
    <body>
        <!-- loading screen-->
        <style>
            #bigblank{
                height:100vh;
                width:100vw;
                position:absolute;
                top:0;
                left:0;
                z-index:100;
                background-color:var(--idle-color);
            }
            #bigblank.inactive{
                display:none;
            }
            #bigblank > div{
                position:absolute;
                top:50%;
                left:50%;
                transform:translate(-50%,-50%);

                font-size: 5em;
            }
        </style>
        <div id="bigblank">
            <div>
                LOADING
            </div>
        </div>

        <!-- main content -->
        <style>
            #main-content{
                width:100vw;
                height:100vh;
                overflow: hidden;
            }
        </style>
        <div id="main-content" class="tab-container data" p:init-vis="redirect_tab">
            <script>
                // indicate that the url should not be changed when a tab is clicked
                let change_location_on_tab_click=false

                p.redirect_tab=function(_element){
                    /// on page load, if the url contains a tab id, redirect to that tab

                    let tab_id=window.location.hash.substring(1)

                    if(tab_id){
                        let tab_body_element=document.querySelector(window.location.hash)
                        if(!tab_body_element){
                            console.error('Tab with id "'+tab_id+'" does not exist!')
                        }

                        let tab_body_name=tab_body_element.getAttribute("tab-name")

                        let tab_element=document.querySelector(`[target-tab-name="${tab_body_name}"]`)
                        tab_element.click()
                    }

                    change_location_on_tab_click=true
                }

                p.tab_to_url=function(entry){
                    /// used by tabs to change the url to the tab id when the tab is clicked (i.e. body is visible)

                    if(!change_location_on_tab_click){
                        return
                    }

                    if(entry.isIntersecting){
                        history.pushState(null, null, '#' + entry.target.id)
                    }
                }
            </script>
            <style>
                #basic-setup-tab{
                    display:grid;
                    grid-template-columns: 1fr 2fr;

                    position:absolute;
                    left:50%;
                    top:50%;
                    transform:translateX(-50%) translateY(-50%);

                    height:50%;
                    width:40%;
                }
                input[type="text"]:not(.invalid){
                    margin:0.2em;
                    margin-bottom:calc( 0.2em - 1px );
                    border-bottom:1px solid black;
                }
                input[type="text"].invalid{
                    border:0.2em solid red;
                    border-radius:0.3em;
                    background-color:rgb(255, 210, 210);
                }
                #basic-config-load-settings-button{
                    grid-column: span 2;
                }
            </style>
            <div class="tab-body data" tab-name="basic setup" id="basic-setup" p:on-vis-change="tab_to_url">
                <div id="basic-setup-tab">
                    <!-- input validation function for project/plate name -->
                    <script>
                        p.check_validity=function(event,highlight_invalid=true){
                            let value=event.currentTarget.value

                            let value_is_valid=true
                            let reason_invalid=null

                            if(value_is_valid){
                                if(value.length==0){
                                    value_is_valid=false
                                    reason_invalid="Please enter a value"
                                }
                            }

                            if(value_is_valid){
                                for(let c of value){
                                    if(c==" "){
                                        value_is_valid=false
                                        reason_invalid="Please do not use spaces"
                                    }else if(/[^a-zA-Z0-9-_]/.test(c)){
                                        value_is_valid=false
                                        reason_invalid="Please enter a valid name.\nThe only allowed characters are a-z, A-Z, 0-9, - (dash), _ (underscore) and . (dot)"
                                    }

                                    if(!value_is_valid){
                                        break
                                    }
                                }
                            }

                            if(!value_is_valid){
                                event.currentTarget.setCustomValidity(reason_invalid)
                                event.currentTarget.classList.add("invalid")
                            }else{
                                event.currentTarget.setCustomValidity("")
                                event.currentTarget.classList.remove("invalid")
                            }

                            if(highlight_invalid){
                                event.currentTarget.reportValidity()
                            }
                        }
                    </script>
                    <label class="data" p:tooltip="Name of the project that this plate is used for. Be aware of upper/lower case!" for="basic-config-project-name">Project Name</label>
                    <script>
                        p.init_project_name=function(element){
                            this.set_project_name({currentTarget:element},false)
                        }
                        p.set_project_name=function(event,highlight_invalid=true){
                            let value=event.currentTarget.value
                            if(value){
                                this.config.project_name=value
                            }
                            this.check_validity(event,highlight_invalid)
                        }
                    </script>
                    <input type="text" id="basic-config-project-name" placeholder="Please enter the Project Name" class="data" p:init="init_project_name" p:on-input="set_project_name" p:on-mouseover,focus="check_validity" value="P19685"/>

                    <label class="data" p:tooltip="Name of the Well Plate. If the plate has a sticker with an ID, use that." for="basic-config-plate-name">Plate Name</label>
                    <script>
                        p.init_plate_name=function(element){
                            this.set_plate_name({currentTarget:element},false)
                        }
                        p.set_plate_name=function(event,highlight_invalid=true){
                            let value=event.currentTarget.value
                            if(value){
                                this.config.plate_name=value
                            }
                            this.check_validity(event,highlight_invalid)
                        }
                    </script>
                    <input type="text" id="basic-config-plate-name" placeholder="Please enter the Plate Name" class="data" p:init="init_plate_name" p:on-input="set_plate_name" p:on-mouseover,focus="check_validity" value="AHSD-G57-PLR-24h"/>

                    <label class="data" for="basic-config-plate-type">Plate Type</label>
                    <script>
                        p.plate_types=[
                            {
                                'name':'Generic 96',
                                'handle':'ge96',
                                'category':'96 Well Plates',
                                'well_count':96,
                                'well_count_x':12,
                                'well_count_y':8
                            },
                            {
                                'name':'Perkin-Elmer 96',
                                'handle':'pe96',
                                'category':'96 Well Plates',
                                'well_count':96,
                                'well_count_x':12,
                                'well_count_y':8
                            },
                            {
                                'name':'Generic 384',
                                'handle':'ge384',
                                'category':'384 Well Plates',
                                'well_count':384,
                                'well_count_x':24,
                                'well_count_y':16
                            },
                            {
                                'name':'Perkin-Elmer 384',
                                'handle':'pe384',
                                'category':'384 Well Plates',
                                'well_count':384,
                                'well_count_x':24,
                                'well_count_y':16
                            },
                            {
                                'name':'Falcon 384',
                                'handle':'fa384',
                                'category':'384 Well Plates',
                                'well_count':384,
                                'well_count_x':24,
                                'well_count_y':16
                            }
                        ]
                        p.get_plate_type=function(handle){
                            for(let plate_type of this.plate_types){
                                if(plate_type.handle==handle){
                                    return plate_type
                                }
                            }
                            return null
                        }
                        p.init_plate_type_dropdown=function(element){
                            this.create_dropdown(element,this.plate_types)

                            this.set_wellplate_type({currentTarget:element})
                        }
                        p.set_wellplate_type=function(event){
                            this.config.plate_type=this.get_plate_type(event.currentTarget.value)
                        }
                    </script>
                    <select class="data" id="basic-config-plate-type" p:init="init_plate_type_dropdown" p:on-change="set_wellplate_type"></select>

                    <label class="data" p:tooltip="Name of Cell Line used on the plate." for="basic-config-cell-line">Cell Line</label>
                    <script>
                        p.init_cell_line=function(element){
                            this.set_cell_line({currentTarget:element},false)
                        }
                        p.set_cell_line=function(event,highlight_invalid=true){
                            let value=event.currentTarget.value
                            if(value){
                                this.config.cell_line=value
                            }
                            this.check_validity(event,highlight_invalid)
                        }
                    </script>
                    <input type="text" id="basic-config-cell-line" placeholder="Please enter the Cell Line" class="data" p:init="init_cell_line" p:on-input="set_cell_line" p:on-mouseover,focus="check_validity" value="U2OS"/>

                    <label class="data" p:tooltip="Base folder that will contain further folders with the images later. TODO: allow browsing the filesystem for this!" for="basic-config-base-path">Base Storage Path</label>
                    <script>
                        p.check_path_validity=function(event){
                            // TODO (send to server and ask if this ok)
                        }
                        p.set_base_path=function(event,highlight_invalid=true){
                            let value=event.currentTarget.value
                            if(value){
                                this.config.base_path=value
                            }
                            this.check_path_validity(event,highlight_invalid)
                        }
                        p.init_base_path=function(element){
                            this.set_base_path({currentTarget:element},false)
                        }
                    </script>
                    <input type="text" id="basic-config-base-path" placeholder="Please enter the Base Path" class="data" p:init="init_base_path" p:on-input="set_base_path,check_path_validity" p:on-mouseover,focus="check_path_validity" value="/mnt/squid"/>

                    <label class="data" p:tooltip="Trigger source for the imaging camera." for="basic-config-camera-trigger">Camera Trigger</label>
                    <script>
                        p.camera_triggers=[
                            {
                                'name':'Hardware',
                                'handle':'hardware'
                            },
                            {
                                'name':'Software',
                                'handle':'software'
                            }
                        ]
                        p.get_camera_trigger=function(handle){
                            for(let camera_trigger of this.camera_triggers){
                                if(camera_trigger.handle==handle){
                                    return camera_trigger
                                }
                            }
                            return null
                        }
                        p.set_camera_trigger=function(event){
                            this.config.camera_trigger=this.get_camera_trigger(event.currentTarget.value)
                        }
                        p.init_camera_trigger_dropdown=function(element){
                            this.create_dropdown(element,this.camera_triggers)
                            this.set_camera_trigger({currentTarget:element})
                        }
                    </script>
                    <select class="data" id="basic-config-camera-trigger" p:init="init_camera_trigger_dropdown" p:on-change="set_camera_trigger"></select>

                    <label class="data" p:tooltip="Imaging camera pixel sensitivity/depth." for="basic-config-pixel-depth">Camera Pixel Depth</label>
                    <script>
                        p.pixel_depths=[
                            {
                                'name':'8 Bit (Monochrome)',
                                'handle':'mono8'
                            },
                            {
                                'name':'12 Bit (Monochrome)',
                                'handle':'mono12'
                            }
                        ]
                        p.get_pixel_depth=function(handle){
                            for(let pixel_depth of this.pixel_depths){
                                if(pixel_depth.handle==handle){
                                    return pixel_depth
                                }
                            }
                            return null
                        }
                        p.init_pixel_depth_dropdown=function(element){
                            this.create_dropdown(element,this.pixel_depths)
                            this.set_pixel_depth({currentTarget:element})
                        }
                        p.set_pixel_depth=function(event){
                            this.config.pixel_depth=this.get_pixel_depth(event.currentTarget.value)
                        }
                    </script>
                    <select class="data" id="basic-config-pixel-depth" p:init="init_pixel_depth_dropdown" p:on-change="set_pixel_depth"></select>

                    <label for="basic-config-image-format">Image File Format</label>
                    <script>
                        p.image_formats=[
                            {
                                'name':'TIFF',
                                'handle':'tiff'
                            },
                            {
                                'name':'TIFF (compressed)',
                                'handle':'tiffcompressed'
                            }
                        ]
                        p.get_image_format=function(handle){
                            for(let image_format of this.image_formats){
                                if(image_format.handle==handle){
                                    return image_format
                                }
                            }
                            return null
                        }
                        p.init_image_format_dropdown=function(element){
                            this.create_dropdown(element,this.image_formats)
                            this.set_image_format({currentTarget:element})
                        }
                        p.set_image_format=function(event){
                            this.config.image_format=this.get_image_format(event.currentTarget.value)
                        }
                    </script>
                    <select class="data" id="basic-config-image-format" p:init="init_image_format_dropdown" p:on-change="set_image_format"></select>

                    <label class="data" p:tooltip="The objective that is currently physically installed on the microscope. (This microscope does not support automatically switching to a different objective, this has to be done manually!)" for="basic-config-objective">Objective</label>
                    <script>
                        p.objectives=[
                            {
                                'name':'4x Magnification (Olympus)',
                                'handle':'olympus4x'
                            },
                            {
                                'name':'10x Magnification (Olympus)',
                                'handle':'olympus10x'
                            },
                            {
                                'name':'20x Magnification (Olympus)',
                                'handle':'olympus20x'
                            }
                        ]
                        p.get_objective=function(handle){
                            for(let objective of this.objectives){
                                if(objective.handle==handle){
                                    return objective
                                }
                            }
                            return null
                        }
                        p.init_objective_dropdown=function(element){
                            this.create_dropdown(element,this.objectives)
                            this.set_objective({currentTarget:element})
                        }
                        p.set_objective=function(event){
                            this.config.objective=this.get_objective(event.currentTarget.value)
                        }
                    </script>
                    <select class="data" id="basic-config-objective" p:init="init_objective_dropdown" p:on-change="set_objective"></select>

                    <button id="basic-config-load-settings-button">Load Existing Settings</button>
                </div>
            </div>

            <style>
                #well-grid-selection:not(.inactive){
                    display:grid;
                    grid-template-columns: 3fr 1fr;
                    height:100%;
                }
            </style>
            <div class="tab-body data" tab-name="well selection + grid" id="well-grid-selection" p:on-vis-change="tab_to_url">
                <!-- left side (well selection) -->
                <style>
                    #well-selection-container{
                        width:100%;
                        height:100%;

                        margin-right:1em;
                        border-right:1px solid black;
                    }

                    #well-selection-area{
                        width:100%;
                        height:100%;
                        
                        display:grid;

                        grid-template-columns: repeat(var(--num-columns), auto);
                        grid-template-rows: repeat(var(--num-rows), auto);

                        justify-content: center;
                        align-items: start;
                        align-content: start;
                        grid-gap:0;

                        overflow: hidden;
                    }
                    .well-item{
                        background-color:white;
                        cursor:pointer;
                        text-align:center;
                        user-select:none;
                        position:relative;

                        width:calc( var(--well-size) - ( var(--border-size) * 2 ) );
                        height:calc( var(--well-size) - ( var(--border-size) * 2 ) );
                        --width:var(--well-size);
                        --height:var(--well-size);

                        --default-background:var(--idle-color);
                        --highlight-color:red;
                        --select-color:var(--active-color);

                        --background:var(--default-background);

                        --border-size: 0.2em;
                        --border-color: var(--highlight-color);
                        padding: var(--border-size); /* fake border width hack */

                        --border-size-left:0;
                        --border-size-right:0;
                        --border-size-top:0;
                        --border-size-bottom:0;

                        background: 
                            linear-gradient(var(--border-color), var(--border-color)) no-repeat left / var(--border-size-left) 100%,
                            linear-gradient(var(--border-color), var(--border-color)) no-repeat right / var(--border-size-right) 100%,
                            linear-gradient(var(--border-color), var(--border-color)) no-repeat top / 100% var(--border-size-top),
                            linear-gradient(var(--border-color), var(--border-color)) no-repeat bottom / 100% var(--border-size-bottom),
                            var(--background);
                    }
                    .well-item[plate-col="0"],.well-item[plate-row="0"]{
                        --default-background:white;

                        font-size:calc(var(--well-size) * 0.6);

                        --border-size:1px;
                        --border-color: black;
                    }
                    .well-item[plate-col="0"]{
                        --border-size-left:var(--border-size);
                        --border-size-right:var(--border-size);
                        --border-size-bottom:var(--border-size);
                    }
                    .well-item[plate-row="0"]{
                        --border-size-right:var(--border-size);
                        --border-size-top:var(--border-size);
                        --border-size-bottom:var(--border-size);
                    }
                    .well-item:not(.well-header):not(.highlighted){
                        font-size: 0;
                    }
                    .well-item:not(.well-header).highlighted{
                        font-size:calc(var(--well-size) * 0.4);
                    }
                    .well-item > div{
                        left:50%;
                        top:50%;
                        transform:translate(-50%,-50%);
                        position:absolute;
                    }
                    .well-item > div.well-item-title-all{
                        transform:translate(-50%,-50%) rotate(-45deg);
                        font-weight: bold;

                        font-size:calc(var(--well-size) * 0.4);
                    }
                    .well-item.selected{
                        --background:var(--select-color);
                    }
                    .well-item.highlight-left{
                        --border-size-left:var(--border-size);
                    }
                    .well-item.highlight-right{
                        --border-size-right:var(--border-size);
                    }
                    .well-item.highlight-top{
                        --border-size-top:var(--border-size);
                    }
                    .well-item.highlight-bottom{
                        --border-size-bottom:var(--border-size);
                    }
                </style>
                <script>
                    p.init_well_selection=function(element){
                        this.well_drag={}

                        let well_count_x=this.config.plate_type.well_count_x+1
                        let well_count_y=this.config.plate_type.well_count_y+1

                        element.style.setProperty("--num-columns",well_count_x)
                        element.style.setProperty("--num-rows",well_count_y)

                        // adjust the number of children, if required
                        if(element.children.length!=well_count_x*well_count_y){
                            while(element.firstChild){
                                element.removeChild(element.firstChild)
                            }

                            for(let y=0;y<well_count_y;y++){
                                for(let x=0;x<well_count_x;x++){
                                    let well=this.templates.well_item.cloneNode(true).firstElementChild

                                    well.setAttribute("plate-col",x)
                                    well.setAttribute("plate-row",y)

                                    let row_name=x
                                    let col_name=String.fromCharCode("A".charCodeAt(0) +y-1)
                                    if(x==0 && y!=0){
                                        well.children[0].innerText=col_name
                                        well.classList.add("well-header")
                                    }else if(y==0 && x!=0){
                                        well.children[0].innerText=row_name
                                        well.classList.add("well-header")
                                    }else if(x==0 && y==0){
                                        well.children[0].innerText="ALL"
                                        well.classList.add("well-header")
                                        well.children[0].classList.add("well-item-title-all")
                                    }else{
                                        well.children[0].innerText=col_name+row_name
                                    }

                                    element.appendChild(well)
                                }
                            }
                        }

                        this.config.well_selection=[]
                        for(let y=0;y<this.config.plate_type.well_count_y;y++){
                            let row=[]
                            for(let x=0;x<this.config.plate_type.well_count_x;x++){
                                row.push(false)
                            }
                            this.config.well_selection.push(row)
                        }

                        // make the children invisible to only get the size of the container, without any potential distortion from the children
                        for(var child of element.children){
                            child.style.display="none"
                        }

                        let container_width=element.offsetWidth
                        let container_height=element.offsetHeight

                        // calculate the size of the wells, so that they fit into the container
                        let well_width=container_width/well_count_x
                        let well_height=container_height/well_count_y

                        // minus 2 for border (TODO)
                        let well_size=Math.min(well_width,well_height)-2

                        // set size and make children visible again
                        for(var child of element.children){
                            child.style.setProperty("--well-size",well_size+"px")
                            child.style.display=null
                        }
                    }
                    p.well_set_selected=function(element){
                        let well_row=element.getAttribute("plate-row")
                        let well_col=element.getAttribute("plate-col")
                        element.classList.add('selected')
                        this.config.well_selection[well_row-1][well_col-1]=true
                    }
                    p.well_set_unselected=function(element){
                        let well_row=element.getAttribute("plate-row")
                        let well_col=element.getAttribute("plate-col")
                        element.classList.remove('selected')
                        this.config.well_selection[well_row-1][well_col-1]=false
                    }
                    p.well_toggle_selection=function(element){
                        let well_row=element.getAttribute("plate-row")
                        let well_col=element.getAttribute("plate-col")
                        element.classList.toggle('selected')
                        this.config.well_selection[well_row-1][well_col-1]=!this.config.well_selection[well_row-1][well_col-1]
                    }

                    p.get_wells_from_current=function(element){
                        /// get all wells that are affected by the current interaction
                        /// if the interaction is on a well, return only that well
                        /// if the interaction is on a row or column, return all wells in that row or column

                        let row=element.getAttribute("plate-row")
                        let col=element.getAttribute("plate-col")

                        let well_elements=[element]
                        if(row==0 && col!=0){
                            well_elements=element.parentElement.querySelectorAll(`[plate-col="${col}"][plate-row]:not([plate-row="0"])`)
                        }else if(col==0 && row!=0){
                            well_elements=element.parentElement.querySelectorAll(`[plate-row="${row}"][plate-col]:not([plate-col="0"])`)
                        }else if(col==0 && row==0){
                            well_elements=element.parentElement.querySelectorAll(`[plate-col]:not([plate-col="0"])[plate-row]:not([plate-row="0"])`)
                        }
                        return well_elements
                    }

                    p.area_leave=function(event){
                        /// cancel drag selection (do not select anything, remove all highlights)

                        this.well_drag.origin=null

                        if(this.well_drag.selected_wells){
                            for(let well of this.well_drag.selected_wells){
                                well.classList.remove("highlight-left")
                                well.classList.remove("highlight-right")
                                well.classList.remove("highlight-top")
                                well.classList.remove("highlight-bottom")
                                well.classList.remove("highlighted")
                            }
                            this.well_drag.selected_wells=[]
                        }
                    }
                    p.well_mousedown=function(event){
                        // init 'well drag' (i.e. click and drag to select multiple wells)
                        this.well_drag={origin:event.currentTarget,selected_wells:[]}

                        // register drag on initial element
                        this.well_mouseenter(event)
                    }
                    p.well_mouseup=function(event){
                        /// end drag selection (select all wells that are in the drag area)

                        if(!this.well_drag.origin){
                            return
                        }

                        let origin_is_header=this.well_drag.origin.classList.contains("well-header")

                        let new_selection_status=!this.well_drag.origin.classList.contains("selected")

                        // if the origin is a well header, then select all in area if at least one is not selected, otherwise (if all are selected) deselect all
                        if(origin_is_header){
                            let all_selected=true
                            for(let well of this.well_drag.selected_wells){
                                if(!well.classList.contains("selected")){
                                    all_selected=false
                                    break
                                }
                            }
                            if(all_selected){
                                new_selection_status=false
                            }
                        }

                        for(let well of this.well_drag.selected_wells){
                            // remove highlight on all wells (except the one where the pointer is currently above)
                            if(well!==event.currentTarget){
                                well.classList.remove("highlight-left")
                                well.classList.remove("highlight-right")
                                well.classList.remove("highlight-top")
                                well.classList.remove("highlight-bottom")
                                well.classList.remove("highlighted")
                            }
                            
                            // actually (de-)select the wells in the highlighted area
                            if(new_selection_status===true){
                                this.well_set_selected(well)
                            }else{
                                this.well_set_unselected(well)
                            }
                        }
                        
                        // indicate stop of drag
                        this.well_drag.origin=null

                        // register mouseenter event on current element to be consistent with expected behaviour
                        this.well_mouseenter(event)
                    }
                    p.well_mouseenter=function(event){
                        // remove highlight on wells in previous drag area
                        let well_container=event.currentTarget.parentElement

                        if(this.well_drag.selected_wells){
                            for(let well of this.well_drag.selected_wells){
                                well.classList.remove("highlight-left")
                                well.classList.remove("highlight-right")
                                well.classList.remove("highlight-top")
                                well.classList.remove("highlight-bottom")
                                well.classList.remove("highlighted")
                            }
                        }
                        this.well_drag.selected_wells=[]

                        // assume only self is currently highlighted
                        let this_row=event.currentTarget.getAttribute("plate-row")
                        let this_col=event.currentTarget.getAttribute("plate-col")

                        let event_start_row=this_row
                        let event_start_col=this_col

                        let event_end_row=this_row
                        let event_end_col=this_col

                        // if there is a drag origin, the highlight area starts at the origin, not here
                        if(this.well_drag.origin){
                            event_start_row=this.well_drag.origin.getAttribute("plate-row")
                            event_start_col=this.well_drag.origin.getAttribute("plate-col")
                        }

                        // if the origin is not the current element, make sure that the start/end of row/col are in the correct order (i.e. start < end)
                        let row_start=Math.min(event_start_row,event_end_row)
                        let row_end=Math.max(event_start_row,event_end_row)
                        let col_start=Math.min(event_start_col,event_end_col)
                        let col_end=Math.max(event_start_col,event_end_col)

                        // get elements in new drag area
                        for(let child of well_container.children){
                            let child_row=child.getAttribute("plate-row")
                            let child_col=child.getAttribute("plate-col")

                            if(child_row>=row_start && child_row<=row_end && child_col>=col_start && child_col<=col_end){
                                for(let el of this.get_wells_from_current(child)){
                                    this.well_drag.selected_wells.push(el)
                                }
                            }
                        }

                        // highlight wells in new drag area

                        // due to special handling of row/column headers above, we need to find the min/max row/column of the selected wells again
                        let min_row=Infinity
                        let max_row=-Infinity
                        let min_col=Infinity
                        let max_col=-Infinity
                        for(let element of this.well_drag.selected_wells){
                            let row=element.getAttribute("plate-row")
                            let col=element.getAttribute("plate-col")

                            min_row=Math.min(min_row,row)
                            max_row=Math.max(max_row,row)
                            min_col=Math.min(min_col,col)
                            max_col=Math.max(max_col,col)
                        }
                        for(let element of this.well_drag.selected_wells){
                            let row=element.getAttribute("plate-row")
                            let col=element.getAttribute("plate-col")

                            element.classList.add("highlighted")
                            if(col==min_col){
                                element.classList.add("highlight-left")
                            }
                            if(col==max_col){
                                element.classList.add("highlight-right")
                            }
                            if(row==min_row){
                                element.classList.add("highlight-top")
                            }
                            if(row==max_row){
                                element.classList.add("highlight-bottom")
                            }
                        }
                    }
                </script>
                <div id="well-selection-container">
                    <h2>Select wells for imaging:</h2>

                    <br/>

                    <script>
                        p.get_num_selected_wells=function(){
                            let num_selected_wells=0
                            if(this.config.well_selection){
                                for(let row of this.config.well_selection){
                                    for(let well of row){
                                        if(well){
                                            num_selected_wells++
                                        }
                                    }
                                }
                            }
                            return num_selected_wells
                        }
                        p.select_every_second_well=function(event){
                            let well_container=event.currentTarget.parentElement.parentElement.querySelector("#well-selection-area")
                            let well_elements=well_container.querySelectorAll(`[plate-col]:not([plate-col="0"])[plate-row]:not([plate-row="0"])`)

                            let begin_index=event.currentTarget.getAttribute("selection_offset")

                            // select every second well
                            // i.e. in row 1, select well 1,3,..., in row 2, select 2,4,... etc.
                            for(let well of well_elements){
                                let row=well.getAttribute("plate-row")
                                let col=well.getAttribute("plate-col")

                                let row_even=row%2==0
                                let col_even=col%2==0
                                if((row_even ^ col_even)==begin_index){
                                    well.classList.add("selected")
                                    p.config.well_selection[row-1][col-1]=true
                                }else{
                                    well.classList.remove("selected")
                                    p.config.well_selection[row-1][col-1]=false
                                }
                            }
                        }
                    </script>
                    <div style="grid-row:2;">
                        <label>Select wells in checkerboard pattern:</label>
                        <button class="data" p:on-click="select_every_second_well" selection_offset="0">starting at A1</button>
                        <button class="data" p:on-click="select_every_second_well" selection_offset="1">starting at A2</button>
                    </div>
                    <br/>

                    <div id="well-selection-area" class="data" p:init-vis="init_well_selection" p:on-resize="init_well_selection" p:on-mouseleave="area_leave">
                        <template name="well_item">
                            <div class="well-item" p:on-mouseenter="well_mouseenter" p:on-mousedown="well_mousedown" p:on-mouseup="well_mouseup">
                                <div><!-- row/column label goes here --></div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- right side (position config) -->
                <style>
                    #grid-config-container{
                        display:grid;

                        grid-template-columns:repeat(4,max-content);
                        padding-left:1em;
                        padding-right:1em;
                    }
                    #grid-config-container>h2{
                        grid-column: 1 / span 4;
                        user-select:none;
                    }
                    #grid-config-container input,#grid-config-container label{
                        text-align: right;
                    }
                    #grid-config-delta-t{
                        display:grid;
                        grid-template-columns: repeat(5,auto);
                    }
                    .input-disabled {
                        pointer-events: none;
                        text-decoration: line-through;
                    }
                    #grid-config-container input{
                        margin-left:0.5em;
                        margin-right:0.5em;
                    }
                </style>
                <script>
                    p.set_grid=function(attribute,event,inputs_to_disable_on_num_one,num_type="int"){
                        let parse_func=parseInt;
                        if(num_type=="float"){
                            parse_func=parseFloat;
                        }
                        let num=parse_func(event.currentTarget.value)

                        if(!this.config.grid){
                            this.config.grid={}
                        }
                        this.config.grid[attribute]=num

                        for(let input_id of inputs_to_disable_on_num_one){
                            let input_element=document.querySelector(input_id)
                            if(num==1){
                                input_element.classList.add("input-disabled")
                                input_element.disabled=true
                            }else{
                                input_element.classList.remove("input-disabled")
                                input_element.disabled=false
                            }
                        }
                    }
                    p.set_grid_num_x=function(event){
                        this.set_grid("num_x",event,["#grid-config-delta-x"])
                    }
                    p.set_grid_num_y=function(event){
                        this.set_grid("num_y",event,["#grid-config-delta-y"])
                    }
                    p.set_grid_num_z=function(event){
                        this.set_grid("num_z",event,["#grid-config-delta-z"])
                    }
                    p.set_grid_num_t=function(event){
                        this.set_grid("num_t",event,[
                            "#grid-config-delta-t-hours",
                            "#grid-config-delta-t-minutes",
                            "#grid-config-delta-t-seconds"
                        ])
                    }

                    p.set_grid_delta_x=function(event){
                        p.set_grid("delta_x",event,[],"float")
                    }
                    p.set_grid_delta_y=function(event){
                        p.set_grid("delta_y",event,[],"float")
                    }
                    p.set_grid_delta_z=function(event){
                        p.set_grid("delta_z",event,[],"float")
                    }
                    p.set_grid_delta_t_h=function(event){
                        p.set_grid("delta_t_h",event,[],"float")
                    }
                    p.set_grid_delta_t_m=function(event){
                        p.set_grid("delta_t_m",event,[],"float")
                    }
                    p.set_grid_delta_t_s=function(event){
                        p.set_grid("delta_t_s",event,[],"float")
                    }

                    p.init_grid=function(_){
                        let grid_num_x_element=document.querySelector("#grid-num-x")
                        this.set_grid_num_x({currentTarget:grid_num_x_element,target:grid_num_x_element})
                        let grid_num_y_element=document.querySelector("#grid-num-y")
                        this.set_grid_num_y({currentTarget:grid_num_y_element,target:grid_num_y_element})
                        let grid_num_z_element=document.querySelector("#grid-num-z")
                        this.set_grid_num_z({currentTarget:grid_num_z_element,target:grid_num_z_element})
                        let grid_num_t_element=document.querySelector("#grid-num-t")
                        this.set_grid_num_t({currentTarget:grid_num_t_element,target:grid_num_t_element})

                        let grid_delta_x_element=document.querySelector("#grid-config-delta-x")
                        this.set_grid_delta_x({currentTarget:grid_delta_x_element,target:grid_delta_x_element})
                        let grid_delta_y_element=document.querySelector("#grid-config-delta-y")
                        this.set_grid_delta_y({currentTarget:grid_delta_y_element,target:grid_delta_y_element})
                        let grid_delta_z_element=document.querySelector("#grid-config-delta-z")
                        this.set_grid_delta_z({currentTarget:grid_delta_z_element,target:grid_delta_z_element})
                        let grid_delta_t_hours_element=document.querySelector("#grid-config-delta-t-hours")
                        this.set_grid_delta_t_h({currentTarget:grid_delta_t_hours_element,target:grid_delta_t_hours_element})
                        let grid_delta_t_minutes_element=document.querySelector("#grid-config-delta-t-minutes")
                        this.set_grid_delta_t_m({currentTarget:grid_delta_t_minutes_element,target:grid_delta_t_minutes_element})
                        let grid_delta_t_seconds_element=document.querySelector("#grid-config-delta-t-seconds")
                        this.set_grid_delta_t_s({currentTarget:grid_delta_t_seconds_element,target:grid_delta_t_seconds_element})
                    }
                </script>
                <div id="grid-config-container" class="data" p:init="init_grid">
                    <h2>Imaging positions within well</h2>

                    <label class="data" p:tooltip="number of x steps to image at within a well">num x positions:</label>
                    <input id="grid-num-x" class="data" type="number" min="1" max="10" step="1" value="2" p:on-change="set_grid_num_x"/>
                    <label class="data" p:tooltip="distance between x steps within well">delta x:</label>
                    <div class="input-unit-container">
                        <input id="grid-config-delta-x" type="number" min="0.1" max="100" step="0.1" value="0.9"/>
                        <p>mm</p>
                    </div>

                    <label class="data" p:tooltip="number of y steps to image at within a well">num y positions:</label>
                    <input id="grid-num-y" class="data" type="number" min="1" max="10" step="1" value="2" p:on-change="set_grid_num_y"/>
                    <label class="data" p:tooltip="distance between y steps within well">delta y:</label>
                    <div class="input-unit-container">
                        <input id="grid-config-delta-y" type="number" min="0.1" max="100" step="0.1" value="0.9"/>
                        <p>mm</p>
                    </div>

                    <label class="data" p:tooltip="number of z steps to image at within a well">num z positions:</label>
                    <input id="grid-num-z" class="data" type="number" min="1" max="1000" step="1" value="1" p:on-change="set_grid_num_z"/>
                    <label class="data" p:tooltip="distance between images in a z-stack">delta z:</label>
                    <div class="input-unit-container">
                        <input id="grid-config-delta-z" type="number" min="0.1" max="100" step="0.1" value="3.0"/>
                        <p>um</p>
                    </div>

                    <label>num timepoints:</label>
                    <input id="grid-num-t" class="data" type="number" min="1" max="999" step="1" value="1" p:on-change="set_grid_num_t"/>
                    <label>delta t:</label>
                    <div id="grid-config-delta-t">
                        <div class="input-unit-container">
                            <input id="grid-config-delta-t-hours" type="number" min="0" max="999" step="1" value="2"/>
                            <p>h</p>
                        </div>
                        <p>,</p>
                        <div class="input-unit-container">
                            <input id="grid-config-delta-t-minutes" type="number" min="0" max="59" step="1" value="0"/>
                            <p>m</p>
                        </div>
                        <p>,</p>
                        <div class="input-unit-container">
                            <input id="grid-config-delta-t-seconds" type="number" min="0" max="59" step="1" value="0"/>
                            <p>s</p>
                        </div>
                    </div>

                    <style>
                        #grid-mask-container{
                                grid-column: span 4;
                        }
                        #grid-mask-title{
                            font-size: 1.2em;
                            margin-bottom:1em;
                            font-weight: bold;
                        }
                    </style>
                    <div id="grid-mask-container">
                        <div id="grid-mask-title">Grid Mask (XY)</div>
                        <style>
                            #grid-mask-selection-container{
                                display:grid;

                                --num-cols:3;
                                --num-rows:3;

                                --item-size:30px;

                                width:100%;
                                height:20em;

                                grid-template-columns: repeat(var(--num-cols), auto);
                                grid-template-rows: repeat(var(--num-rows), auto);

                                justify-content: center;
                                align-items: start;
                                align-content: start;
                            }
                            .grid-mask-selection-item{
                                background-color:var(--idle-color);
                                cursor:pointer;

                                height:calc( var(--item-size) - 2px );
                                width:calc( var(--item-size) - 2px );
                                border:1px solid black;
                            }
                            .grid-mask-selection-item.selected{
                                background-color:var(--active-color);
                            }
                            .grid-mask-y-header{
                                text-align:center;
                                font-weight:bold;
                                transform:rotate(-90deg);
                                transform-origin: right bottom;
                                height:1.5em;
                                width:1.5em;
                                overflow: visible;
                            }
                            .grid-mask-y-header>div{
                                position:absolute;
                                height:1.5em;
                                width:max-content;
                                left:50%;
                                transform:translateX(-70%);
                            }
                            .grid-mask-x-header{
                                text-align:center;
                                font-weight:bold;
                                height:1.5em;
                                width:max-content;
                            }
                        </style>
                        <script>
                            // adjust number and size of items in the grid selection window to num. pos. in x/y
                            p.adjust_children=function(info){
                                if(!this.templates.grid_mask_selection_item){
                                    return
                                }

                                // assume this function is called with the objchange callback
                                let element=info.element
                                if(!element){
                                    // if function was called with init-vis instead, this path should be taken
                                    element=info
                                }

                                let num_x=this.config.grid.num_x+1
                                let num_y=this.config.grid.num_y+1

                                this.config.grid.mask=[]

                                while(element.firstElementChild){
                                    element.removeChild(element.firstElementChild)
                                }

                                let child_item_size=Math.min(element.offsetWidth/num_x,element.offsetHeight/num_y)
                                element.style.setProperty("--item-size",child_item_size+"px")
                                element.style.setProperty("--num-cols",num_x)
                                element.style.setProperty("--num-rows",num_y)

                                for(let y=0;y<num_y-1;y++){
                                    let row=[]
                                    for(let x=0;x<num_x-1;x++){
                                        let item=this.templates.grid_mask_selection_item.cloneNode(true).firstElementChild
                                        element.appendChild(item)

                                        item.setAttribute("grid-row",y)
                                        item.setAttribute("grid-col",x)

                                        row.push(true)
                                    }
                                    this.config.grid.mask.push(row)
                                }

                                let blank_item=document.createElement("div")
                                blank_item.style.setProperty("grid-column","1")
                                blank_item.style.setProperty("grid-row","1")
                                element.appendChild(blank_item)

                                let x_header=document.createElement("div")
                                x_header.classList.add("grid-mask-x-header")
                                x_header.innerText="X Positions"
                                x_header.style.setProperty("grid-column","2 / span "+(num_x-1))
                                x_header.style.setProperty("grid-row","1")
                                element.appendChild(x_header)

                                let y_header=document.createElement("div")
                                y_header.classList.add("grid-mask-y-header")
                                y_header.innerHTML="<div>Y Positions</div>"
                                y_header.style.setProperty("grid-column","1")
                                y_header.style.setProperty("grid-row","2 / span "+(num_y-1))
                                element.appendChild(y_header)
                            }
                            p.grid_mask_item_toggle=function(event){
                                event.currentTarget.classList.toggle("selected")
                                let grid_row=event.currentTarget.getAttribute("grid-row")
                                let grid_col=event.currentTarget.getAttribute("grid-col")
                                this.config.grid.mask[grid_row][grid_col]=!this.config.grid.mask[grid_row][grid_col]
                            }
                        </script>
                        <div id="grid-mask-selection-container" class="data" p:init-vis="adjust_children" p:on-objchange(p.config.grid.num_x&p.config.grid.num_y)="adjust_children">
                            <template name="grid_mask_selection_item">
                                <div class="grid-mask-selection-item selected data" p:on-click="grid_mask_item_toggle"></div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>

            <style>
                #channel-focus-setup:not(.inactive){
                    display:grid;
                    grid-template-columns: 1fr 2fr;
                    height:100%;
                    overflow:hidden;
                }
                #channel-focus-setup *{
                    overflow:hidden;
                }
                #channel-container{
                    display:grid;
                    grid-template-columns: 1fr;
                    grid-template-rows: repeat(100,min-content);

                    overflow-y: auto;
                    overflow-x: auto;
                }
            </style>
            <div class="tab-body data" tab-name="channel + focus setup" id="channel-focus-setup" p:on-vis-change="tab_to_url">
                <script>
                    p.add_channel_config_item=function(event){
                        let channel_config_item_template=p.templates["channel_config_item"]
                        let channel_config_item=channel_config_item_template.cloneNode(true)

                        let channel_container=event.currentTarget.parentNode
                        channel_container.insertBefore(channel_config_item,event.currentTarget)
                    }
                    p.light_sources=[
                        {
                            'name':'405nm Laser',
                            'handle':'laser405nm',
                            'category':'Fluorescence'
                        },
                        {
                            'name':'488nm Laser',
                            'handle':'laser488nm',
                            'category':'Fluorescence'
                        },
                        {
                            'name':'561nm Laser',
                            'handle':'laser561nm',
                            'category':'Fluorescence'
                        },
                        {
                            'name':'638nm Laser',
                            'handle':'laser638nm',
                            'category':'Fluorescence'
                        },
                        {
                            'name':'730nm Laser',
                            'handle':'laser730nm',
                            'category':'Fluorescence'
                        },
                        {
                            'name':'Brightfield LED (full)',
                            'handle':'bffull',
                            'category':'Brightfield'
                        },
                        {
                            'name':'Brightfield LED (right half)',
                            'handle':'bfrighthalf',
                            'category':'Brightfield'
                        },
                        {
                            'name':'Brightfield LED (left half)',
                            'handle':'bflefthalf',
                            'category':'Brightfield'
                        },
                    ]
                    p.init_lightsource_dropdown=function(element){
                        this.create_dropdown(element,this.light_sources)
                    }

                    p.channel_move_up=function(event){
                        let channel_config_item=event.currentTarget.parentNode
                        let channel_config_item_prev=channel_config_item.previousSibling
                        if(channel_config_item_prev){
                            channel_config_item.parentNode.insertBefore(channel_config_item,channel_config_item_prev)
                        }
                    }
                    p.channel_move_down=function(event){
                        let channel_config_item=event.currentTarget.parentNode
                        let channel_config_item_next=channel_config_item.nextSibling
                        if(channel_config_item_next && channel_config_item_next!=document.querySelector("#channel-config-add-item-button")){
                            channel_config_item.parentNode.insertBefore(channel_config_item_next,channel_config_item)
                        }
                    }
                    p.remove_channel=function(event){
                        let channel_config_item=event.currentTarget.parentNode
                        channel_config_item.parentNode.removeChild(channel_config_item)
                    }
                    p.duplicate_channel=function(event){
                        let channel_config_item=event.currentTarget.parentNode
                        let channel_config_item_clone=channel_config_item.cloneNode(true)
                        if(channel_config_item_clone.children[0].value.length>0){
                            channel_config_item_clone.children[0].value+=" (copy)"
                        }
                        // insert copy immediately after original
                        channel_config_item.parentNode.insertBefore(channel_config_item_clone,channel_config_item.nextSibling)
                    }
                    p.investigate_channel=function(event){
                        let channel_config_item=event.currentTarget.parentNode
                        let channel_name=channel_config_item.children[0].value
                        let lightsource=channel_config_item.children[3].value
                        let exposure_time=channel_config_item.children[5].children[0].value
                        let illumination=channel_config_item.children[7].children[0].value
                        let analog_gain=channel_config_item.children[9].value
                        let z_offset=channel_config_item.children[11].children[0].value

                        console.log("investigate channel",channel_name,lightsource,exposure_time,illumination,analog_gain,z_offset)
                    }
                </script>
                <style>
                    #channel-container{
                        padding-left:0.3em;
                        padding-right:0.3em;

                        margin-right:1em;
                        border-right:1px solid black;
                    }
                    .channel-config-item{
                        display:grid;
                        grid-template-columns: auto auto auto auto;
                        grid-template-rows: repeat(6,min-content);

                        border-bottom: 1px solid black;
                        padding-bottom: 0.5em;
                        margin-bottom: 0.2em;

                        column-gap: 1em;
                        row-gap:0.2em;
                    }
                    .channel-config-item-name{
                        font-size: 1.5em;
                        font-weight: bold;
                    }
                    #channel-config-add-item-button{
                        font-size:1.3em;
                        padding:0.5em;
                        margin:0.2em;
                        margin-top: 1em;
                        border:1px solid black;
                    }
                    .col-4{
                        grid-column: span 4;
                    }
                    .col-3{
                        grid-column: span 3;
                    }
                    .col-2{
                        grid-column: span 2;
                    }
                    .channel-config-item>button{
                        padding:0.5em;
                        border:1px solid black;
                    }
                    .input-unit-container{
                        display:grid;
                        grid-template-columns:1fr auto;
                    }
                </style>
                <!-- left side (channel overview) -->
                <div id="channel-container" class="data">
                    <template name="channel_config_item">
                        <div class="channel-config-item">
                            <script>
                                p.validate_channel_name=function(event){
                                    element=event.currentTarget
                                    if(!element){
                                        element=event
                                    }
                                    if(element.value.length==0){
                                        element.classList.add("invalid")
                                        element.setCustomValidity("Channel name must not be empty.")
                                        element.reportValidity()
                                    }else{
                                        element.classList.remove("invalid")
                                        element.setCustomValidity("")
                                    }
                                }
                            </script>
                            <input class="col-3 channel-config-item-name data" p:tooltip="Name of this channel (used for metadata only). This should be the name of dye. Use the name of the organelle only if there is no dye in this channel." type="text" p:init-vis="validate_channel_name" p:on-input="validate_channel_name" placeholder="Enter Channel Name"/>

                            <button class="data" p:tooltip="Investigate this channel in the panel on the right." p:on-click="investigate_channel">Investigate &rarr;</button>

                            <label>Light source:</label>
                            <select class="col-3 data" p:init="init_lightsource_dropdown"></select>

                            <label class="data" p:tooltip="Exposure time in milliseconds. This is the time the sample is excited by light, during which the camera records the light emitted by the sample.">Exposure time:</label>
                            <div class="input-unit-container">
                                <input type="number" min="0.1" max="936" step="0.1" value="10" wheel-adjust="false"/>
                                <p>ms</p>
                            </div>

                            <label class="data" p:tooltip="Fraction of the maximum power of the light source with which it illuminates the sample. Must be in range [0;100%]">Light Power:</label>
                            <div class="input-unit-container">
                                <input type="number" min="0" max="100" step="0.1" value="100" wheel-adjust="false"/>
                                <p>%</p>
                            </div>

                            <label class="data" p:tooltip="Analog gain increases the camera sensor sensitivity. This makes a weaker signal appear stronger, but may increase the level of noise in the image.">Analog Gain:</label>
                            <input type="number" min="0" max="24" step="0.1" value="0" wheel-adjust="false"/>

                            <label class="data" p:tooltip="The z-offset of the imaging plane of this channel from the focus plane of the current position.">Z-Offset:</label>
                            <div class="input-unit-container">
                                <input type="number" min="-300" max="300" step="0.1" value="0" wheel-adjust="false"/>
                                <p>um</p>
                            </div>

                            <button class="data" p:tooltip="Move this channel up in the imaging order." p:on-click="channel_move_up">Move Up</button>
                            <button class="data" p:tooltip="Move this channel down in the imaging order."  p:on-click="channel_move_down">Move Down</button>
                            <button class="data" p:tooltip="Create a copy of this channel."  p:on-click="duplicate_channel">Duplicate</button>
                            <button class="data" p:tooltip="Delete this channel."  p:on-click="remove_channel">Remove</button>
                        </div>
                    </template>
                    <button id="channel-config-add-item-button" class="data" p:on-click="add_channel_config_item">Add Channel</button>
                </div>

                <!-- right side (channel investigation) -->
                <div>
                    <style>
                        #objective-position-container{
                            display:grid;
                            grid-template-columns: repeat(4,auto);

                            column-gap: 1em;
                            row-gap:0.2em;
                        }
                        .xyz-pos-grid{
                            display:grid;
                            grid-template-columns: auto auto auto;
                        }
                        .grid-col-3{
                            display:grid;
                            grid-template-columns: auto auto auto;
                        }
                    </style>
                    <div id="objective-position-container">
                        <div style="grid-column: span 4;">Objective/Stage Position:</div>

                        <div>
                            <div>current position:</div>
                            <div class="xyz-pos-grid">
                                <label>x</label><input type="number" value="34.91"/><p>mm</p>
                                <label>y</label><input type="number" value="54.34"/><p>mm</p>
                                <label>z</label><input type="number" value="2345.67"/><p>um</p>
                            </div>
                        </div>

                        <div>
                            <select>
                                <option>move to (absolute)</option>
                                <option selected>move by (relative)</option>
                            </select>
                            <div class="xyz-pos-grid">
                                <label>x</label><input type="number" value="0"/><p>mm</p>
                                <label>y</label><input type="number" value="0"/><p>mm</p>
                                <label>z</label><input type="number" value="0"/><p>um</p>
                            </div>
                            <button>execute</button>
                        </div>
                        
                        <div>
                            <div>go to</div>
                            <div class="grid-col-3">
                                <div>well</div><input type="text" value="A8"/><button>browse</button>
                                <div>position</div><input type="text" value="r3 x c3 : r2 c2"/><button>browse</button>
                            </div>
                            <button>execute</button>
                        </div>

                        <div>
                            <button>enter loading position</button>
                            <button>leave loading position</button>
                        </div>
                    </div>
                    <div>
                        <h2>Live View</h2>
                        <style>
                            #live-view-display{
                                width:100%;
                                height:auto;
                                border:1px solid black;
                            }
                        </style>
                        <script>
                            p.onsrcchange=function(element){
                                element.children[element.children.length-1].firstElementChild.setAttribute("src",element.getAttribute("src"))
                                center_image_on_load(element.children[element.children.length-1].firstElementChild)
                            }
                        </script>
                        <style>
                            #live-view-container{
                                display:grid;
                                grid-template-columns: 1fr 1fr;
                                grid-gap:1em;
                            }
                        </style>
                        <div id="live-view-container">
                            <div id="live-view-display" style="background-color:gray;" class="dynamic-image-display notitle data" p:on-attrchange(src)="onsrcchange"></div>
                            <div>
                                <div>
                                    <h3>enhance brightness</h3>
                                    <label>brightness</label><input type="number" min="0" max="10" value="1.0" step="0.1"/>
                                </div>
                                <div>
                                    <label>indicate saturated pixels?</label>
                                    <script>
                                        let img_src=null
                                        let saturated=false
                                        let res_flag=null

                                        let _icantbelieveihavetodothis={intervalid:0}
                                        p.load_new_image=function(_){
                                            let img_element=document.getElementById("live-view-display")

                                            let new_img_src=img_src
                                            if(saturated){
                                                new_img_src=new_img_src.replace('.tif','.saturated.tif')
                                            }
                                            if(res_flag){
                                                new_img_src=new_img_src.replace('.tif',res_flag+'.tif')
                                            }
                                            img_element.setAttribute("src",new_img_src)
                                            
                                            if(_icantbelieveihavetodothis.intervalid){
                                                clearInterval(_icantbelieveihavetodothis.intervalid)
                                            }

                                            _icantbelieveihavetodothis.intervalid=setInterval(()=>{
                                                try{
                                                    p.make_into_histogram(img_element)
                                                }catch(e){
                                                    return
                                                }

                                                clearInterval(_icantbelieveihavetodothis.intervalid)
                                            },50)
                                        }
                                        p.make_into_histogram=function(element){
                                            this.histogram_from_image(this.get_img_data(element.children[0].children[0]))
                                        }

                                        p.change_saturated_pixel_indicator=function(event){
                                            saturated=event.currentTarget.checked
                                            this.load_new_image()
                                        }
                                    </script>
                                    <input type="checkbox" class="data" p:on-change="change_saturated_pixel_indicator"/>
                                </div>
                                <script>
                                    p.set_img_src=function(event){
                                        let element=event.currentTarget||event

                                        img_src=element.value

                                        this.load_new_image()
                                    }
                                    p.set_img_scale=function(event){
                                        let element=event.currentTarget||event

                                        res_flag=element.value

                                        this.load_new_image()
                                    }
                                </script>
                                <select class="data" p:init-vis="set_img_src" p:on-change="set_img_src">
                                    <option value="cells.tiff">cells.tiff</option>
                                    <option value="cells2.tiff">cells2.tiff</option>
                                </select>
                                <select class="data" p:init-vis="set_img_scale" p:on-change="set_img_scale">
                                    <option value=".highres">full res</option>
                                    <option value=".halfres">1/2 res</option>
                                    <option value=".midres" selected>1/5 res</option>
                                    <option value=".lowres">1/10 res</option>
                                </select>

                                <script>
                                    p.plotly_resize=function(element){
                                        let plotContainer=element
                                        let update={
                                            width: plotContainer.clientWidth,
                                            height: plotContainer.clientHeight
                                        }
                                        Plotly.relayout(element, update)
                                    }
                                </script>
                                <div id="histogram" class="data" p:on-resize="plotly_resize">
                                    <style>
                                        #histogram{
                                            width:100%;
                                            height:400px;
                                        }
                                    </style>
                                    <script>
                                        let y_axis_log_scale=true
                                        p.histogram_from_image=function(image){
                                            // histogram is created on the R (red) channel only
                                            
                                            var y_data = []
                                            var x_data = []
                                            for(let i=0;i<256;i++){
                                                y_data.push(0)
                                                x_data.push(i)
                                            }

                                            let num_pixels_in_image=image.width*image.height
                                            let num_image_color_channels=image.data.length/num_pixels_in_image

                                            for(let i=0;i<image.data.length;i+=num_image_color_channels){
                                                y_data[image.data[i]]++
                                            }

                                            if(y_data[0]==num_pixels_in_image){
                                                throw new Error("image is empty, cannot create histogram")
                                            }

                                            var trace = {
                                                x: x_data,
                                                y: y_data,
                                                fill: 'tozeroy',
                                                type: 'scatter',
                                                mode: 'lines'
                                            }
                                            var layout = {
                                                title: 'Histogram',
                                                xaxis: {
                                                    title: 'Signal intensity',
                                                    tickvals: [  0,    64, 128,    192,255],
                                                    ticktext: ['0','0.25','0.5','0.75','1'],
                                                },
                                                yaxis: {
                                                    title: 'Relative count',
                                                    // only provide ticks for 0 (numbers on this axis are largely irrelevant)
                                                    tickvals: [0],
                                                    ticktext: ['0']
                                                },
                                                autosize: true,
                                                // reduce margin size to reduce blank space around plot
                                                margin: {l: 40, r: 40, b: 40, t: 40}
                                            }

                                            if(y_axis_log_scale){
                                                layout.yaxis.type="log"
                                                layout.yaxis.title+=" (log scale)"

                                                layout.yaxis.tickvals.push(1)
                                                layout.yaxis.ticktext.push('1')
                                            }

                                            let config={scrollZoom: true}

                                            Plotly.newPlot('histogram', [trace], layout, config)
                                        }
                                    </script>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h2>Focus (auto & manual)</h2>
                        <button>Set Laser Autofocus Reference</button>
                        <div>
                            <button>measure offset</button>
                            <p>offset:</p><p>6.634</p><p>um</p>
                        </div>
                        <div class="data" p:tooltip="focus measure could be a real focus measure, or the max intensity (which actually works great in practice)">graph of software focus measure vs z (?)</div>
                    </div>
                </div>
            </div>

            <style>
                #tab-config-summary .config-accepted::before {
                    display:inline-block;
                    content: "\2713 "; /* Unicode for checkmark */
                    color: green; /* Color for checkmark */
                    padding-left:0.5em;
                    padding-right:0.5em;
                }

                #tab-config-summary .config-rejected::before,#tab-config-summary>ul>:not(.config-accepted)::before {
                    display:inline-block;
                    content: "\2717 "; /* Unicode for cross */
                    color: red; /* Color for cross */
                    padding-left:0.5em;
                    padding-right:0.5em;
                }
            </style>
            <div class="tab-body data" tab-name="review" id="tab-config-summary" p:on-vis-change="tab_to_url">
                <h2>Acquisition Summary:</h2>
                <br/>

                <script>
                    p.review_set_trigger_name=function(info){
                        let element=info.element || info
                        element.innerText=this.config.camera_trigger.name
                    }
                    p.review_set_bit_depth=function(info){
                        let element=info.element || info
                        element.innerText=this.config.pixel_depth.name
                    }
                    p.review_set_image_format=function(info){
                        let element=info.element || info
                        element.innerText=this.config.image_format.name
                    }
                    p.review_set_objective=function(info){
                        let element=info.element || info
                        element.innerText=this.config.objective.name
                    }
                    p.review_set_plate_type=function(info){
                        let element=info.element || info
                        element.innerText=this.config.plate_type.name
                    }
                    p.review_set_base_path=function(info){
                        let element=info.element || info
                        element.innerText=this.config.base_path
                    }
                    p.review_set_project_name=function(info){
                        let element=info.element || info
                        element.innerText=this.config.project_name
                    }
                    p.review_set_plate_name=function(info){
                        let element=info.element || info
                        element.innerText=this.config.plate_name
                    }
                    p.review_set_cell_line=function(info){
                        let element=info.element || info
                        element.innerText=this.config.cell_line
                    }
                    p.review_set_wells_selected=function(info){
                        let element=info.element || info
                        element.innerText=this.get_num_selected_wells()+" wells selected"
                    }
                    p.review_set_grid_positions=function(info){
                        let element=info.element || info
                        // get number of selected items in the grid mask
                        let num_selections_in_mask=0
                        if(this.config.grid.mask){
                            for(let row of this.config.grid.mask){
                                for(let item of row){
                                    if(item){
                                        num_selections_in_mask++
                                    }
                                }
                            }
                        }
                        // calculate total number of positions per wlel
                        let num_total_positions_per_well=num_selections_in_mask*this.config.grid.num_z*this.config.grid.num_t
                        element.innerText=`${num_total_positions_per_well} ( x: ${this.config.grid.num_x} , y: ${this.config.grid.num_y} , z: ${this.config.grid.num_z} , t: ${this.config.grid.num_t} , mask: ${num_selections_in_mask}/${this.config.grid.num_x*this.config.grid.num_y})`
                    }
                </script>
                <style>
                    #review-item-table{
                        display:grid;
                        grid-template-columns: auto auto 1fr;
                    }
                </style>
                <div id="review-item-table">
                    <div class="config-accepted"></div>
                    <div>Trigger:</div>
                    <div class="data" p:init="review_set_trigger_name" p:on-objchange(p.config.camera_trigger)="review_set_trigger_name"></div>

                    <div class="config-accepted"></div>
                    <div>Pixel Depth:</div>
                    <div class="data" p:init="review_set_bit_depth" p:on-objchange(p.config.pixel_depth)="review_set_bit_depth"></div>

                    <div class="config-accepted"></div>
                    <div>Image Format:</div>
                    <div class="data" p:init="review_set_image_format" p:on-objchange(p.config.image_format)="review_set_image_format"></div>

                    <div class="config-accepted"></div>
                    <div>Objective:</div>
                    <div class="data" p:init="review_set_objective" p:on-objchange(p.config.objective)="review_set_objective"></div>

                    <div class="config-accepted"></div>
                    <div>Plate Type:</div>
                    <div class="data" p:init="review_set_plate_type" p:on-objchange(p.config.plate_type)="review_set_plate_type"></div>

                    <div class="config-accepted"></div>
                    <div>num wells selected:</div>
                    <div class="data" p:init="review_set_wells_selected" p:on-objchange(p.config.well_selection)="review_set_wells_selected" p:tooltip="selected wells: A1, A2, A3, ... [TODO: exhaustive list goes here, nicely formatted]"></div>

                    <div class="config-accepted"></div>
                    <div>Positions per well:</div>
                    <div class="data" p:init="review_set_grid_positions" p:on-objchange(p.config.grid)="review_set_grid_positions" p:tooltip="[TODO: show essentially screenshot or something of the grid mask ]">9</div>

                    <div class="config-accepted"></div>
                    <div>Focus System:</div>
                    <div class="data">per-position laser autofocus</div>

                    <div class="config-accepted"></div>
                    <div>Project Name:</div>
                    <div class="data" p:init="review_set_project_name" p:on-objchange(p.config.project_name)="review_set_project_name"></div>

                    <div class="config-accepted"></div>
                    <div>Plate Name:</div>
                    <div class="data" p:init="review_set_plate_name" p:on-objchange(p.config.plate_name)="review_set_plate_name"></div>

                    <div class="config-accepted"></div>
                    <div>Cell Line:</div>
                    <div class="data" p:init="review_set_cell_line" p:on-objchange(p.config.cell_line)="review_set_cell_line"></div>

                    <div class="config-accepted"></div>
                    <div>Base Storage Path:</div>
                    <div><code class="data" p:init="review_set_base_path" p:on-objchange(p.config.base_path)="review_set_base_path">/mnt/squid</code></div>

                    <div class="config-accepted"></div>
                    <div>imaging channels:</div>
                    <div class="" id="channelreviewitem">
                        <style>
                            #channelreviewitem{
                                display:grid;
                                grid-template-columns: auto 1fr;
                            }
                        </style>

                        <ol class="">
                            <li class="data" p:tooltip="name: Nucleus ; light source: 405nm Laser ; exposure time: 4.5ms ; [TODO: add remaining information]">Nucleus</li>
                            <li class="data" p:tooltip="name: ER ; light source: 488nm Laser ; exposure time: 13.0ms ; [TODO: add remaining information]">ER</li>
                            <li class="data" p:tooltip="name: Golgi ; light source: 561nm Laser ; exposure time: 54.0ms ; [TODO: add remaining information]">Golgi</li>
                        </ol>
                        <style>
                            #allchannelhistogram{
                                width:400px;
                                height:250px;
                            }
                        </style>
                        <script>
                            p.createallchannelhistogram=function(_){
                                let x_data=[]
                                let y_data=[]

                                for(let c=0;c<5;c++){
                                    y_data.push([])
                                    for(let i=0;i<256;i++){
                                        y_data[c].push(0)

                                        if(c==0){
                                            x_data.push(i)
                                        }
                                    }
                                }

                                for(let c=0;c<5;c++){
                                    for(let j=0;j<256;j++){
                                        y_data[c][j]=Math.sin(j/300*(c+1)*Math.PI+c)+0.7+(c+1)/5
                                    }
                                }

                                var traces = []
                                for(let c=0;c<5;c++){
                                    traces.push({
                                        x: x_data,
                                        y: y_data[c],
                                        type: 'scatter',
                                        mode: 'lines',
                                        name: 'channel '+(1+c)
                                    })
                                }
                                var layout = {
                                    title: 'Histogram',
                                    xaxis: {
                                        title: 'Signal intensity',
                                        tickvals: [  0,    64, 128,    192,255],
                                        ticktext: ['0','0.25','0.5','0.75','1'],
                                    },
                                    yaxis: {
                                        title: 'Relative count',
                                        // only provide ticks for 0 (numbers on this axis are largely irrelevant)
                                        tickvals: [0],
                                        ticktext: ['0']
                                    },
                                    autosize: true,
                                    // reduce margin size to reduce blank space around plot
                                    margin: {l: 40, r: 40, b: 40, t: 40}
                                }

                                /*if(y_axis_log_scale){
                                    layout.yaxis.type="log"
                                    layout.yaxis.title+=" (log scale)"

                                    layout.yaxis.tickvals.push(1)
                                    layout.yaxis.ticktext.push('1')
                                }*/

                                let config={scrollZoom: true}

                                Plotly.newPlot('allchannelhistogram', traces, layout, config)
                            }
                        </script>
                        <div id="allchannelhistogram" class="data" p:init="createallchannelhistogram"></div>
                    </div>

                    <div></div>
                    <div></div>
                    <div></div>

                    <div class="config-accepted"></div>
                    <div>final output path:</div>
                    <script>
                        let fullpathnamefetchcontroller = null
                        let fullpathnamefetchobject=null
                        p.set_review_full_output_path=function(info){
                            if(fullpathnamefetchobject){
                                fullpathnamefetchcontroller.abort()
                            }

                            fullpathnamefetchobject=null
                            fullpathnamefetchcontroller=new AbortController()

                            fullpathnamefetchobject=fetch('/api/fullPathName', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                signal:fullpathnamefetchcontroller.signal,
                                body: JSON.stringify(this.config.copyRaw()) // if you need to send a payload
                            }).then(response => {
                                if (!response.ok) {
                                    throw new Error('Network response was not ok');
                                }
                                return response.json(); // or response.text() if the response is not JSON // <- this is a Response object, which is awaited through the .then
                            }).then((data)=>{
                                let element=(info.element||info)
                                element.innerText=data.full_output_path
                            }).catch(error => {
                                if(error.name!='AbortError'){
                                    console.error('There was a problem with the fetch operation:', error);
                                }
                            });
                        }
                        let requiredstoragefetchcontroller=null
                        let requiredstoragefetchobject=null
                        p.set_review_storage_required=function(info){
                            if(requiredstoragefetchobject){
                                requiredstoragefetchcontroller.abort()
                            }

                            requiredstoragefetchobject=null
                            // create new abortcontroller for this object specifically. re-using an existing controller that was used to send an abort signal will send this same signal to any new fetch objects created with it as a signal source even if they are created after the abort signal has been sent
                            requiredstoragefetchcontroller = new AbortController()

                            requiredstoragefetchobject=fetch('/api/requiredStorage', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                signal:requiredstoragefetchcontroller.signal,
                                body: JSON.stringify(this.config.copyRaw()) // if you need to send a payload
                            }).then(response => {
                                if (!response.ok) {
                                    throw new Error('Network response was not ok');
                                }
                                return response.json(); // or response.text() if the response is not JSON // <- this is a Response object, which is awaited through the .then
                            }).then((data)=>{
                                let data_as_kbytes=data.max_required_storage/1024
                                let data_as_Mbytes=data_as_kbytes/1024
                                let data_as_Gbytes=data_as_Mbytes/1024
                                let data_as_Tbytes=data_as_Gbytes/1024

                                let element=(info.element||info)
                                if(data_as_Mbytes<1){
                                    element.innerText=data_as_kbytes.toFixed(2)+" kB"
                                }else if(data_as_Gbytes<1){
                                    element.innerText=data_as_Mbytes.toFixed(2)+" MB"
                                }else if(data_as_Tbytes<1){
                                    element.innerText=data_as_Gbytes.toFixed(2)+" GB"
                                }else{
                                    element.innerText=data_as_Tbytes.toFixed(2)+" TB"
                                }
                            }).catch(error => {
                                if(error.name!='AbortError'){
                                    console.error('There was a problem with the fetch operation:', error);
                                }
                            });
                        }
                    </script>
                    <div class="data" p:init="set_review_full_output_path" p:on-objchange(p.config)="set_review_full_output_path"></div>
                    
                    <div class="config-accepted"></div>
                    <div>max. storage used for output:</div>
                    <div class="data" p:init="set_review_storage_required" p:on-objchange(p.config)="set_review_storage_required" p:tooltip="maximum storage required to store all images. because TIFF (compressed) is used as image file format, the actually used storage may be smaller.">123GB</div>

                    <div class="config-accepted"></div>
                    <div>estimated imaging time:</div>
                    <div class="data" p:tooltip="estimated imaging time based on rolling dice or something. better estimate is available once imaging has started.">1h 23m</div>
                </div>

                <br/>

                <style>
                    #review-run-button{
                        padding:1em;
                        margin:0.5em;
                        border:1px solid black;
                    }
                </style>
                <div>
                    <h2>Server Status:</h2>
                    <br/>
                    <ul>
                        <li>Config accepted</li>
                        <li>Microscope idle</li>
                    </ul>
                </div>

                <br/>

                <button id="review-run-button">RUN (the acquisition)</button>
            </div>

            <div class="tab-body data" tab-name="Status" id="tab-device-status" p:on-vis-change="tab_to_url">
                <div>
                    <p>54 / 90 images done (61%)</p>
                    <p>has been running for 34m 54s (since 2023-10-24 13:11:43)</p>
                    <p>estimated time left is 23m 43s (done by 2023-10-24 14:12:39)</p>
                    <p>64GB used so far (58% of max.)</p>
                </div>
                <div>
                    last image that was taken is shown here
                </div>
                <div>
                    histogram of last image here
                </div>
                <div>
                    system metrics:
                    <ul>
                        <li>laser autofocus success rate:
                            <ul>
                                <li>1 : 85%</li>
                                <li>2 : 9%</li>
                                <li>3 : 5%</li>
                                <li>>3 : 1%</li>
                            </ul>
                        </li>
                        <li>storage queue occupancy rate: 0 (100%)</li>
                        <li>
                            warning/errors:
                            <ul>
                                <li>(none so far)</li>
                            </ul>
                        </li>
                        <li>acquisition log file size: 384kB (12kB/m)</li>
                    </ul>
                </div>
            </div>
        </div>

        <script>
            document.addEventListener('keydown',p.save_config_on_ctrlcmd_s)
        </script>

        <!-- utility tools and general functionality -->
        <div id="element_containing_external_links" style="display:none;">
            <!-- tab component -->
            <link rel="stylesheet" href="components/tab/style.css">
            <script src="components/tab/logic.js"></script>

            <!-- dynamic image component -->
            <link rel="stylesheet" href="components/dynamic-image/style.css">
            <script src="components/dynamic-image/logic.js"></script>

            <!-- tooltip html component -->
            <p style="display:none;" class="data">
                <style>
                    .tooltip:not(.processed){
                        display:none;
                    }
                    .tooltip-container{
                        width:auto;
                        max-width:40vw;

                        position:absolute;
                        z-index:100;
                        background:white;
                        border:1px solid black;

                        transform:translateY(-100%) translateX(-50%);
                        padding:0.3em;
                        background-color:lightyellow;
                    }
                </style>
                <script>
                    p.bare_init_tooltip=function(element){
                        /// init tooltip to be definitely visible (which it should be, in the top left corner of the viewport)
                        element.style.left="0px"
                        element.style.top="0px"
                    }.bind(p)
                    p.init_tooltip=function(element){
                        /// actually init element position to top center of the element that it is attached to
                        let rect=element.element_anker.getBoundingClientRect()

                        let left_offset=rect.left+rect.width/2
                        let top_offset=rect.top
                    
                        element.style.left=left_offset+"px"
                        element.style.top=rect.top +"px"

                        // if tooltip is outside the viewport, shove it back in
                        let tooltip_rect=element.getBoundingClientRect()

                        let left_min=tooltip_rect.width/2
                        let right_min=tooltip_rect.width/2

                        // check left
                        if(tooltip_rect.left<0){
                            element.style.left=left_min+"px"
                        }
                        // check right
                        if(tooltip_rect.right<0){
                            element.style.right=right_min+"px"
                        }
                        // check top
                        if(tooltip_rect.top<0){
                            element.style.top="0px"
                        }
                        // check bottom
                        if(tooltip_rect.bottom<0){
                            element.style.bottom="0px"
                        }
                    }.bind(p)
                </script>
                <template name="tooltip">
                    <div class="tooltip-container data" p:init="bare_init_tooltip" p:init-vis="init_tooltip"></div>
                </template>
            </p>

            <!-- loading page done - deactive loading screen overlay-->
            <script>
                let mutation_observer=new MutationObserver((mutations)=>{
                    mutations.forEach((mutation)=>{
                        if(mutation.type=="childList"){
                            for(let node of mutation.addedNodes){
                                p.init(node,true)
                            }
                        }
                    })
                })
                mutation_observer.observe(document.body,{attributes:false,childList:true,characterData:false,subtree:true})

                setTimeout(function(){
                    document.getElementById("bigblank").classList.add("inactive")
                },300)
            </script>
        </div>
    </body>
</html>